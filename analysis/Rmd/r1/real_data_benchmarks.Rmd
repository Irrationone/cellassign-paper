---
title: "Real data benchmarking report"
output: 
  html_document:
    toc: true
    toc_depth: 5
---


```{r global_chunk_options, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, tidy = FALSE, warning = FALSE, message = FALSE, cache = FALSE, cache.lazy = FALSE, fig.width = 8, fig.height = 4.5)
```

```{r}
library(tidyverse)
library(data.table)
library(scater)
library(scran)
library(yaml)

library(cellassign.utils)
library(scrna.utils)
```

# Human liver data

## All data

```{r}
fit_liver_alldata_allmarkers <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/liver_alldata_allmarkers.rds')
fit_liver_alldata_allmarkers_fixed <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/liver_alldata_allmarkers_fixed.rds')
fit_liver_alldata_3markers <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/liver_alldata_3markers.rds')
fit_liver_alldata_3markers_revised <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/liver_alldata_3markers_revised.rds')
fit_liver_alldata_3markers_2 <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/liver_alldata_3markers_2.rds')
fit_liver_alldata_3markers_2_revised <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/liver_alldata_3markers_2_revised.rds')
fit_liver_panglaodb_full <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/liver_panglaodb_full.rds')
fit_liver_panglaodb_canonical <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/liver_panglaodb_canonical.rds')
fit_liver_panglaodb_canonical_revised <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/liver_panglaodb_canonical_revised.rds')
```

```{r}
sce_liver <- readRDS('/datadrive/projects/cellassign-paper/results/scratch/real_data_benchmarking/v1/sce_normalized/mcparland_liver.rds')

sce_liver$fit_liver_alldata_3markers <- fit_liver_alldata_3markers$cell_type
sce_liver$fit_liver_alldata_3markers_revised <- fit_liver_alldata_3markers_revised$cell_type
sce_liver$fit_liver_alldata_3markers_2 <- fit_liver_alldata_3markers_2$cell_type
sce_liver$fit_liver_alldata_3markers_2_revised <- fit_liver_alldata_3markers_2_revised$cell_type
sce_liver$fit_liver_alldata_allmarkers <- fit_liver_alldata_allmarkers$cell_type
sce_liver$fit_liver_alldata_allmarkers_fixed <- fit_liver_alldata_allmarkers_fixed$cell_type
sce_liver$fit_liver_panglaodb_full <- fit_liver_panglaodb_full$cell_type
sce_liver$fit_liver_panglaodb_canonical <- fit_liver_panglaodb_canonical$cell_type
sce_liver$fit_liver_panglaodb_canonical_revised <- fit_liver_panglaodb_canonical_revised$cell_type
```

```{r}
liver_celltype_colours <- get_colour_palette(colnames(fit_liver_alldata_allmarkers_fixed$mle_params$delta))
```

Using the marker gene list from BaderLab's HumanLiver, with a few corrections (to account for shared genes):

```{r}
plotTSNE(sce_liver, colour_by = "fit_liver_alldata_allmarkers_fixed")
```

We next look at what happens when we only look at a few cell types. First, consider only mature B cells, hepatocytes, and cholangiocytes, using the original BaderLab marker list:


```{r}
plotTSNE(sce_liver, colour_by = "celltype") + 
  xlab("TSNE-1") + 
  ylab("TSNE-2") + 
  guides(fill = guide_legend(title = "McParland et al. type")) + 
  scale_fill_manual(values = liver_celltype_colours)
```

```{r}
plotTSNE(sce_liver, colour_by = "fit_liver_alldata_3markers") + 
  xlab("TSNE-1") + 
  ylab("TSNE-2") + 
  guides(fill = guide_legend(title = "Cellassign type")) + 
  scale_fill_manual(values = liver_celltype_colours)
```

```{r}
marker_genes <- c("MS4A1", "CD52", "LTB", "IGHD")
marker_expression_plots <- lapply(marker_genes, function(x) {
  plotTSNE(sce_liver, colour_by = get_ensembl_id(x, sce_liver), point_alpha = 0.3, point_size = 0.8) + 
    xlab("TSNE-1") + 
    ylab("TSNE-2") + 
    guides(fill = guide_colorbar(title = "")) + 
    ggtitle(x)
})

cowplot::plot_grid(plotlist = marker_expression_plots, nrow = 2, ncol = 2, align = 'hv', axis = 'tblr')
```

The B cell subset seems to be capturing a portion of the B cell and ab T cell subsets. This is due to the choice of marker genes -- out of the 4 marker genes specified for mature B cells, 2 are also expressed in ab T cells (CD52 and LTB). Excluding these, and adding in well-known B cell marker CD19, we can get:

```{r}
plotTSNE(sce_liver, colour_by = "fit_liver_alldata_3markers_revised") + 
  xlab("TSNE-1") + 
  ylab("TSNE-2") + 
  guides(fill = guide_legend(title = "Cellassign type")) + 
  scale_fill_manual(values = liver_celltype_colours)
```

which is what we expected. 


We show this on an additional example:

```{r}
plotTSNE(sce_liver, colour_by = "fit_liver_alldata_3markers_2")
```

where we consider T cells instead of B cells, to see whether phenotypically similar gd T cell subsets will be captured. 

```{r}
plotTSNE(sce_liver, colour_by = "fit_liver_alldata_3markers_2_revised")
```

```{r}
plotTSNE(sce_liver, colour_by = "fit_liver_panglaodb_canonical_revised") + 
  xlab("TSNE-1") + 
  ylab("TSNE-2") + 
  guides(fill = guide_legend(title = "Cellassign type")) + 
  scale_fill_manual(values = liver_celltype_colours) + 
  ggtitle("PanglaoDB signatures")
```

## 4 cell types

```{r}
fit_liver_4data_3markers <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/liver_4data_3markers.rds')
```

```{r}
sce_liver_4_types <- sce_liver %>%
  scater::filter(celltype %in% c("Cholangiocytes", "Mature B cells", "Hepatocytes", "NK cells"))
```

```{r}
sce_liver_4_types$fit_liver_4data_3markers <- fit_liver_4data_3markers$cell_type
```

```{r}
plotTSNE(sce_liver_4_types, colour_by = "fit_liver_4data_3markers") + 
  xlab("TSNE-1") + 
  ylab("TSNE-2") + 
  guides(fill = guide_legend(title = "Cellassign type")) + 
  scale_fill_manual(values = liver_celltype_colours)
```

## Liver 3 types

```{r}
fit_liver_3data_3markers <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/liver_3data_3markers.rds')
fit_liver_3data_allmarkers <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/liver_3data_allmarkers.rds')
fit_liver_3data_4markers <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/liver_3data_4markers.rds')
fit_liver_3data_4markers_2 <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/liver_3data_4markers_2.rds')
```

```{r}
sce_liver_3_types <- sce_liver %>%
  scater::filter(celltype %in% c("Cholangiocytes", "Mature B cells", "Hepatocytes"))
sce_liver_3_types_2 <- sce_liver %>%
  scater::filter(celltype %in% c("NK cells", "Mature B cells", "Hepatocytes"))
```

```{r}
sce_liver_3_types$fit_liver_3data_3markers <- fit_liver_3data_3markers$cell_type
sce_liver_3_types$fit_liver_3data_allmarkers <- fit_liver_3data_allmarkers$cell_type
sce_liver_3_types$fit_liver_3data_4markers <- fit_liver_3data_4markers$cell_type
sce_liver_3_types_2$fit_liver_3data_4markers_2 <- fit_liver_3data_4markers_2$cell_type
```

```{r}
p1 <- plotTSNE(sce_liver_3_types, colour_by = "fit_liver_3data_3markers") + 
  xlab("TSNE-1") + 
  ylab("TSNE-2") + 
  guides(fill = guide_legend(title = "Cellassign type", ncol = 2)) + 
  scale_fill_manual(values = liver_celltype_colours) + 
  ggtitle("Markers for 3 types") + 
  theme_bw() + 
  theme_Publication() + 
  theme_nature()
```

```{r}
p2 <- plotTSNE(sce_liver_3_types, colour_by = "fit_liver_3data_4markers") + 
  xlab("TSNE-1") + 
  ylab("TSNE-2") + 
  guides(fill = guide_legend(title = "Cellassign type", ncol = 2)) + 
  scale_fill_manual(values = liver_celltype_colours) + 
  ggtitle("Markers for 3 types + NK cells") + 
  theme_bw() + 
  theme_Publication() + 
  theme_nature()

cowplot::plot_grid(p1, p2, align = 'hv', axis = 'tblr')
```

```{r}
plotTSNE(sce_liver_3_types, colour_by = "fit_liver_3data_allmarkers") + 
  xlab("TSNE-1") + 
  ylab("TSNE-2") + 
  guides(fill = guide_legend(title = "Cellassign type")) + 
  scale_fill_manual(values = liver_celltype_colours) + 
  ggtitle("Markers for all 11 cell types")
```


# CellBench data

## Mixtures

```{r}
fit_tian20 <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/tian_20markers.rds')
fit_tian30 <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/tian_30markers.rds')
fit_tian50 <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/tian_50markers.rds')
```

```{r}
tian_3_celseq <- readRDS('/datadrive/projects/cellassign-paper/results/scratch/real_data_benchmarking/v1/sce_normalized/tian_3_CELseq2.rds')
tian_3_mixture <- readRDS('/datadrive/projects/cellassign-paper/results/scratch/real_data_benchmarking/v1/sce_normalized/tian_mixture3.rds')

colData(tian_3_celseq)$sample_id <- 'celseq'
colData(tian_3_mixture)$sample_id <- 'mixture'

merge_sces <- function(sces) {
  coldata_union <- Reduce(union, lapply(sces, function(x) {
    colnames(colData(x))
  }))
  
  common_genes <- Reduce(intersect, lapply(sces, function(x) {
    rownames(x)
  }))
  
  sces <- lapply(sces, function(x) {
    missing_cols <- setdiff(coldata_union, colnames(colData(x)))
    rowdat_cols <- setdiff(colnames(rowData(x)), c("mean_counts", "log10_mean_counts",
                                                   "n_cells_by_counts", "pct_dropout_by_counts", "total_counts",
                                                   "log10_total_counts"))
    rowData(x) <- rowData(x)[,rowdat_cols]
    colData(x)[,missing_cols] <- NA
    colData(x) <- colData(x)[,coldata_union]
    x <- x[common_genes,]
    return(x)
  })
  
  sce <- Reduce(cbind, sces)
  
  # Recompute size factors
  qclust <- quickCluster(sce, min.size = 30)
  sce <- computeSumFactors(sce, clusters = qclust)
  
  sce$size_factor <- sizeFactors(sce)
  return(sce)
}
```

```{r}
sce_tian_mix <- merge_sces(list(tian_3_celseq, tian_3_mixture))
cell_lines <- c("H1975", "H2228", "HCC827")

for (cl in cell_lines) {
  colData(sce_tian_mix)[,cl][sce_tian_mix$cell_line == cl] <- 9
  colData(sce_tian_mix)[,cl][sce_tian_mix$cell_line != cl] <- 0
}
```

```{r}
fit_objects <- list('20'=fit_tian20, '30'=fit_tian30, '50'=fit_tian50)
cellassign_probs <- plyr::rbind.fill(lapply(seq_along(fit_objects), function(i) {
  fit <- fit_objects[[i]]
  gammas <- reshape2::melt(fit$mle_params$gamma) %>%
    dplyr::rename(cell_id=Var1, cell_line=Var2, cellassign_prob=value) %>%
    dplyr::mutate(group=names(fit_objects)[i])
  return(gammas)
}))
cellassign_probs$group <- factor(cellassign_probs$group)
```

```{r}
true_probs <- colData(sce_tian_mix)[,c("sample_id", cell_lines)] %>%
  as.data.frame %>%
  dplyr::mutate(cell_id=1:n()) %>%
  reshape2::melt(id.vars = c("cell_id", "sample_id"), variable.name = "cell_line", value.name = "num_cells")

valid_cells <- true_probs %>%
  dplyr::group_by(sample_id, cell_id) %>%
  dplyr::summarise(total_cells=sum(num_cells)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(total_cells == "9")
```

```{r}
prob_df <- true_probs %>%
  dplyr::left_join(cellassign_probs) %>%
  dplyr::filter(cell_id %in% valid_cells$cell_id,
                sample_id == "mixture")
```

```{r}
ggplot(prob_df, aes(x=factor(num_cells), y=cellassign_prob, fill = factor(group))) + 
  geom_boxplot(alpha = 0.7, position = "dodge", outlier.size = -1) + 
  geom_point(alpha = 0.2, position = position_jitterdodge(jitter.width = 0.2, jitter.height = 0)) + 
  theme_bw() + 
  theme_Publication() + 
  theme_nature() + 
  facet_wrap(~ cell_line, ncol = 1) + 
  stripped_theme(strip_face = "bold") + 
  guides(fill = guide_legend(title = "Number of marker genes")) + 
  xlab("# cells in 9-cell barcode") + 
  ylab("CellAssign probability")
```

This result shows how CellAssign probabilities relate to ground truth mixtures of phenotypes, validating the usefulness of probabilities from CellAssign. 

```{r}
entropies <- prob_df %>% dplyr::group_by(cell_id, group, sample_id) %>% dplyr::summarise(pure=ifelse(max(num_cells) == 9, "Pure", "Mixture"), entropy=entropy.empirical(cellassign_prob))

pvals <- compute_pvals_subsets(entropies, facet_vars = c("group"), formula = entropy ~ pure, corfun = wilcox.test, output = "p.value")

ggplot(entropies, aes(x=pure, y=entropy)) + 
  geom_boxplot(position = "dodge", outlier.size = -1) + 
  geom_point(alpha = 0.5, position = position_jitter(width = 0.2, height = 0)) + 
  theme_bw() + 
  theme_Publication() + 
  theme_nature() + 
  facet_wrap(~ group, ncol = 3) + 
  stripped_theme(strip_face = "bold") + 
  xlab("Pseudocell type") + 
  ylab("Entropy") + 
  geom_text(data = pvals, aes(label=p.adj.text), parse = TRUE, x = Inf, y = Inf, hjust = 1.1, vjust = 1.3, size = 3)
```

## 10x vs. CELseq2

```{r}
fit_tian_pure <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/tian_pure.rds')
```

```{r}
tian_3_10x <- readRDS('/datadrive/projects/cellassign-paper/results/scratch/real_data_benchmarking/v1/sce_normalized/tian_3_10x.rds')
tian_3_celseq <- readRDS('/datadrive/projects/cellassign-paper/results/scratch/real_data_benchmarking/v1/sce_normalized/tian_3_CELseq2.rds')
tian_3_Dropseq <- readRDS('/datadrive/projects/cellassign-paper/results/scratch/real_data_benchmarking/v1/sce_normalized/tian_3_Dropseq.rds')
```

```{r}
colData(tian_3_10x)$sample_id <- '10x'
colData(tian_3_celseq)$sample_id <- 'celseq'
colData(tian_3_Dropseq)$sample_id <- 'Dropseq'
```

```{r}
sce_tian_pure <- merge_sces(list(tian_3_10x, tian_3_celseq, tian_3_Dropseq))
```

```{r}
sce_tian_pure$cellassign_class <- fit_tian_pure$cell_type

sce_tian_pure <- normalize(sce_tian_pure)
sce_tian_pure <- runPCA(sce_tian_pure, ntop = 1000, ncomponents = 50, exprs_values = "logcounts")
sce_tian_pure <- runTSNE(sce_tian_pure, use_dimred = "PCA", n_dimred = 50, ncomponents = 2)
sce_tian_pure <- runUMAP(sce_tian_pure, use_dimred = "PCA", n_dimred = 50, ncomponents = 2)
```

```{r}
tian_celltype <- get_colour_palette(sce_tian_pure$cell_line)

p1 <- plotTSNE(sce_tian_pure, colour_by = "cell_line") + 
  xlab("TSNE-1") + 
  ylab("TSNE-2") + 
  guides(fill = guide_legend(title = "Cell line", ncol = 2)) + 
  scale_fill_manual(values = tian_celltype) +
  ggtitle("Cell line") + 
  theme_bw() + 
  theme_Publication() + 
  theme_nature()

p2 <- plotTSNE(sce_tian_pure, colour_by = "sample_id") + 
  xlab("TSNE-1") + 
  ylab("TSNE-2") + 
  guides(fill = guide_legend(title = "Method", ncol = 2)) + 
  ggtitle("Method") + 
  theme_bw() + 
  theme_Publication() + 
  theme_nature()

p3 <- plotTSNE(sce_tian_pure, colour_by = "cellassign_class") + 
  xlab("TSNE-1") + 
  ylab("TSNE-2") + 
  guides(fill = guide_legend(title = "Cellassign type", ncol = 2)) + 
  scale_fill_manual(values = tian_celltype) +
  ggtitle("CellAssign") + 
  theme_bw() + 
  theme_Publication() + 
  theme_nature()

cowplot::plot_grid(p1, p2, p3, ncol = 3, align = 'hv', axis = 'tblr')
```

```{r}
with(colData(sce_tian_pure), table(cellassign_class, cell_line))
```


# Follicular lymphoma

```{r}
fit_follicular_lk_full <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/follicular_lk_full.rds')
fit_follicular_broad <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/follicular_broad.rds')
fit_follicular_lk_separate <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/follicular_lk_separate.rds')
```

```{r}
sce_fl <- readRDS('/datadrive/projects/cellassign-paper/results/scratch/real_data_benchmarking/v1/sce_normalized/follicular.rds')
sce_fl_bcell <- readRDS('/datadrive/projects/cellassign-paper/results/scratch/real_data_benchmarking/v1/sce_normalized/follicular_bcell.rds')
```

```{r}
sce_fl$fit_follicular_lk_full <- fit_follicular_lk_full$cell_type
sce_fl$fit_follicular_broad <- fit_follicular_broad$cell_type
sce_fl_bcell$fit_follicular_lk_separate <- fit_follicular_lk_separate$cell_type
```

```{r}
plotTSNE(sce_fl, colour_by = "fit_follicular_lk_full")
```

```{r}
fl_table1 <- with(colData(sce_fl), table(fit_follicular_broad, fit_follicular_lk_full))

print(fl_table1)
```

```{r}
combined_probs <- data.frame(type = "combined", fit_follicular_lk_full$mle_params$gamma, check.names = FALSE) %>%
  dplyr::mutate(Barcode=sce_fl$Barcode, Sample=sce_fl$Sample)
broad_probs <- data.frame(type = "hierarchical", fit_follicular_broad$mle_params$gamma, check.names = FALSE) %>%
  dplyr::mutate(Barcode=sce_fl$Barcode, Sample=sce_fl$Sample)
specific_probs <- data.frame(type = "hierarchical", fit_follicular_lk_separate$mle_params$gamma, check.names = FALSE) %>%
  dplyr::mutate(Barcode=sce_fl_bcell$Barcode, Sample=sce_fl_bcell$Sample)

hierarchical_probs <- broad_probs %>% 
  dplyr::left_join(specific_probs, by = c("Sample", "Barcode", "type")) %>%
  dplyr::mutate(`B cells (kappa)` = `B cells` * IGKC,
                `B cells (lambda)` = `B cells` * IGLC) %>%
  dplyr::select(-c(IGKC, IGLC))

combined_probs <- combined_probs %>%
  dplyr::mutate(`B cells` = `B cells (kappa)` + `B cells (lambda)`)

hierarchical_melted <- hierarchical_probs %>%
  reshape2::melt(id.vars = c("type", "Sample", "Barcode"), variable.name = "celltype", value.name = "probability") %>%
  dplyr::mutate(celltype = as.character(celltype)) %>%
  dplyr::filter(!is.na(probability),
                !str_detect(celltype, "^other"))
combined_melted <- combined_probs %>%
  reshape2::melt(id.vars = c("type", "Sample", "Barcode"), variable.name = "celltype", value.name = "probability") %>%
  dplyr::mutate(celltype = as.character(celltype)) %>%
  dplyr::filter(!is.na(probability),
                !str_detect(celltype, "^other"))

other_barcodes <- Reduce(rbind, list(colData(sce_fl)[fit_follicular_lk_full$cell_type == "other",c("Sample", "Barcode")],
                                     colData(sce_fl)[fit_follicular_broad$cell_type == "other",c("Sample", "Barcode")],
                                     colData(sce_fl_bcell)[fit_follicular_lk_separate$cell_type == "other",c("Sample", "Barcode")])
                         ) %>%
  unique %>%
  as.data.frame %>%
  dplyr::mutate(class = "other")

total_melted <- hierarchical_melted %>%
  dplyr::rename(hierarchical_prob=probability) %>%
  dplyr::inner_join(combined_melted %>% dplyr::rename(combined_prob=probability), by = c("celltype", "Sample", "Barcode")) %>%
  dplyr::left_join(other_barcodes)

total_melted$class[is.na(total_melted$class)] <- "valid"

total_melted <- total_melted %>%
  dplyr::filter(class == "valid")
```


```{r}
ggplot(total_melted %>%
         dplyr::filter(!celltype %in% c("B cells (lambda)", "B cells (kappa)")), aes(x=combined_prob, hierarchical_prob)) + 
  geom_point(alpha = 0.1, position = position_jitter(width = 0.02, height = 0.02)) + 
  geom_smooth(method='lm',formula=y~x) +
  theme_bw() + 
  theme_Publication() + 
  theme_nature() + 
  facet_wrap(~ celltype, ncol = 2) + 
  stripped_theme(strip_face = "bold") + 
  xlab("Probability (combined matrix)") + 
  ylab("Probability (hierarchical strategy)")
```

```{r}
ggplot(total_melted %>%
         dplyr::mutate(unique_barcode=paste0(Sample, "_", Barcode)) %>%
         dplyr::filter(celltype %in% c("B cells (lambda)", "B cells (kappa)"),
                       unique_barcode %in% with(specific_probs, paste0(Sample, "_", Barcode))), aes(x=combined_prob, hierarchical_prob)) + 
  geom_point(alpha = 0.05, position = position_jitter(width = 0.02, height = 0.02)) + 
  geom_smooth(method='lm',formula=y~x) +
  theme_bw() + 
  theme_Publication() + 
  theme_nature() + 
  facet_wrap(~ celltype, ncol = 2) + 
  stripped_theme(strip_face = "bold") + 
  xlab("Probability (combined matrix)") + 
  ylab("Probability (hierarchical strategy)")
```


# HGSC and FL combined

```{r}
fit_follicular_hgsc_combined <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/real_data_benchmarking/v1/cellassign/follicular_hgsc_combined.rds')
fit_hgsc <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/hgsc_analysis/v2/broad_assignments.rds')
```

```{r}
sce_hgsc <- readRDS('/datadrive/projects/cellassign-paper/results/scratch/real_data_benchmarking/v1/sce_normalized/hgsc.rds')
sce_hgsc_old <- readRDS('/datadrive/projects/cellassign-paper/results/outputs/hgsc_analysis/v2/sce_hgsc_annotated_final.rds')

sce_follicular_hgsc_merged <- merge_sces(list(sce_fl, sce_hgsc))
sce_follicular_hgsc_merged <- normalize(sce_follicular_hgsc_merged)
sce_follicular_hgsc_merged <- runPCA(sce_follicular_hgsc_merged, ntop = 1000, ncomponents = 50, exprs_values = "logcounts")
sce_follicular_hgsc_merged <- runTSNE(sce_follicular_hgsc_merged, use_dimred = "PCA", n_dimred = 50, ncomponents = 2)
sce_follicular_hgsc_merged <- runUMAP(sce_follicular_hgsc_merged, use_dimred = "PCA", n_dimred = 50, ncomponents = 2)

sce_follicular_hgsc_merged <- sce_follicular_hgsc_merged %>%
  scater::mutate(dataset = ifelse(str_detect(patient, "^VOA"), "HGSC", "FL"))
```

```{r}
sce_follicular_hgsc_merged$fit_follicular_hgsc_combined <- fit_follicular_hgsc_combined$cell_type
```

```{r}
celltype_colours <- get_colour_palette(c(sce_follicular_hgsc_merged$fit_follicular_hgsc_combined, fit_hgsc$cell_type, fit_follicular_lk_full$cell_type))

p1 <- plotTSNE(sce_follicular_hgsc_merged, colour_by = "fit_follicular_hgsc_combined") + 
  xlab("TSNE-1") + 
  ylab("TSNE-2") + 
  theme_bw() + 
  theme_Publication() + 
  theme_nature() + 
  guides(fill = guide_legend(title = "CellAssign type", ncol = 2)) + 
  ggtitle("CellAssign") + 
  scale_fill_manual(values = celltype_colours)
p2 <- plotTSNE(sce_follicular_hgsc_merged, colour_by = "dataset") + 
  xlab("TSNE-1") + 
  ylab("TSNE-2") + 
  theme_bw() + 
  theme_Publication() + 
  theme_nature() + 
  guides(fill = guide_legend(title = "Dataset")) + 
  ggtitle("Dataset")

cowplot::plot_grid(p1, p2, ncol = 2, align = 'hv', axis = 'tblr')
```


```{r}
hgsc_assignments <- colData(sce_hgsc_old)[,c("Sample", "Barcode")] %>%
  cbind(fit_hgsc$mle_params$gamma) %>%
  data.frame(check.names = FALSE) 
fl_assignments <- colData(sce_fl)[,c("Sample", "Barcode")] %>%
  cbind(fit_follicular_lk_full$mle_params$gamma) %>%
  data.frame(check.names = FALSE) 
combined_assignments <- colData(sce_follicular_hgsc_merged)[,c("Sample", "Barcode")] %>%
  cbind(fit_follicular_hgsc_combined$mle_params$gamma) %>%
  data.frame(check.names = FALSE) %>%
  dplyr::mutate(`B cells` = `B cells (kappa)` + `B cells (lambda)`,
                `T cells` = `Cytotoxic T cells` + `CD4 T cells` + `Tfh`)
```

```{r}
match_probabilities <- function(a1, a2, id.vars = c("Sample", "Barcode"), variable.name = "celltype") {
  a1_melted <- reshape2::melt(a1, id.vars = id.vars, variable.name = variable.name, value.name = "prob1")
  a2_melted <- reshape2::melt(a2, id.vars = id.vars, variable.name = variable.name, value.name = "prob2")
  
  probs <- a1_melted %>%
    dplyr::inner_join(a2_melted)
  
  return(probs)
}
```

```{r}
hgsc_combined_probs <- match_probabilities(hgsc_assignments, combined_assignments)

ggplot(hgsc_combined_probs %>%
         dplyr::filter(celltype != "other"), aes(x=prob1, y=prob2)) + 
  geom_smooth(method = "lm") + 
  geom_point(alpha = 0.2) + 
  theme_bw() + 
  theme_Publication() + 
  theme_nature() + 
  facet_wrap(~ celltype) + 
  stripped_theme(strip_face = "bold") + 
  xlab("Probability (HGSC only)") + 
  ylab("Probability (HGSC+FL)")
```

```{r}
fl_combined_probs <- match_probabilities(fl_assignments, combined_assignments)

ggplot(fl_combined_probs %>%
         dplyr::filter(celltype != "other"), aes(x=prob1, y=prob2)) + 
  geom_smooth(method = "lm") + 
  geom_point(alpha = 0.2) + 
  theme_bw() + 
  theme_Publication() + 
  theme_nature() + 
  facet_wrap(~ celltype) + 
  stripped_theme(strip_face = "bold") + 
  xlab("Probability (FL only)") + 
  ylab("Probability (HGSC+FL)")
```

```{r}
hgsc_map <- colData(sce_hgsc_old)[,c("Sample", "Barcode")]
hgsc_map$fit_hgsc <- fit_hgsc$cell_type 

fl_map <- colData(sce_fl)[,c("Sample", "Barcode")]
fl_map$fit_fl <- fit_follicular_lk_full$cell_type

combined_map <- colData(sce_follicular_hgsc_merged)[,c("Sample", "Barcode")]
combined_map$fit_combined <- fit_follicular_hgsc_combined$cell_type

merged_map_hgsc <- combined_map %>%
  as.data.frame %>%
  dplyr::mutate(fit_combined = plyr::mapvalues(fit_combined, from = c("B cells (kappa)", "B cells (lambda)", "CD4 T cells", "Cytotoxic T cells", "Tfh"), to = c("B cells", "B cells", "T cells", "T cells", "T cells"))) %>%
  dplyr::inner_join(hgsc_map %>% as.data.frame)

merged_map_fl <- combined_map %>%
  as.data.frame %>%
  dplyr::inner_join(fl_map %>% as.data.frame)
```

```{r}
with(merged_map_hgsc, table(fit_hgsc, fit_combined))
with(merged_map_fl, table(fit_fl, fit_combined))

with(merged_map_hgsc, sum(fit_hgsc == fit_combined)/length(fit_hgsc))
with(merged_map_fl, sum(fit_fl == fit_combined)/length(fit_fl))
```

```{r}
colData(sce_follicular_hgsc_merged) <- colData(sce_follicular_hgsc_merged) %>%
  as.data.frame %>%
  dplyr::left_join(hgsc_map %>% as.data.frame) %>%
  dplyr::left_join(fl_map %>% as.data.frame) %>%
  DataFrame()

p1 <- plotTSNE(sce_follicular_hgsc_merged, colour_by = "fit_hgsc") + 
  xlab("TSNE-1") + 
  ylab("TSNE-2") + 
  theme_bw() + 
  theme_Publication() + 
  theme_nature() + 
  guides(fill = guide_legend(title = "CellAssign type", ncol = 2)) + 
  ggtitle("CellAssign (HGSC)") + 
  scale_fill_manual(values = celltype_colours)

p2 <- plotTSNE(sce_follicular_hgsc_merged, colour_by = "fit_fl") + 
  xlab("TSNE-1") + 
  ylab("TSNE-2") + 
  theme_bw() + 
  theme_Publication() + 
  theme_nature() + 
  guides(fill = guide_legend(title = "CellAssign type", ncol = 2)) + 
  ggtitle("CellAssign (FL)") + 
  scale_fill_manual(values = celltype_colours)

cowplot::plot_grid(p1, p2, align = 'hv', axis = 'tblr', ncol = 2)
```
